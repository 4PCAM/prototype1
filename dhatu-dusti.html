<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhatu Dusti Assessment - 4-PCAM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 500;
        }

        .content {
            padding: 40px;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 50px;
            height: 8px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #00b894, #00a085);
            height: 100%;
            width: 75%;
            border-radius: 50px;
            transition: width 0.5s ease;
        }

        .assessment-header {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .assessment-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .assessment-header h3 {
            font-size: 2em;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
            font-weight: 600;
        }

        .assessment-header p {
            position: relative;
            z-index: 1;
            font-size: 1.1em;
        }

        .patient-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .patient-info-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .patient-info-item strong {
            color: #2d3436;
            display: block;
            margin-bottom: 5px;
        }

        .instructions {
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            color: #2d3436;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
            border-left: 6px solid #74b9ff;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.2);
        }

        .dhatu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .dhatu-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .dhatu-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .dhatu-header {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            padding: 20px;
            text-align: center;
            font-weight: 700;
            color: #2d3436;
            font-size: 1.1em;
            position: relative;
        }

        .dhatu-content {
            padding: 25px;
        }

        .dhatu-symptoms {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .symptom-category {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .symptom-category h5 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .symptom-list {
            list-style: none;
            padding: 0;
        }

        .symptom-item {
            background: white;
            margin: 8px 0;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            position: relative;
            user-select: none;
        }

        .symptom-item:hover {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-color: #667eea;
            transform: translateX(5px);
        }

        .symptom-item.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .severity-controls {
            display: none;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .symptom-item.selected .severity-controls {
            display: flex;
        }

        .severity-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            min-width: 30px;
            font-weight: 600;
        }

        .severity-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
            transform: scale(1.1);
        }

        .severity-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: white;
            transform: scale(1.15);
        }

        .dhatu-scores {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .score-display {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }

        .score-value {
            font-size: 24px;
            font-weight: 800;
            display: block;
            margin-bottom: 5px;
        }

        .selected-dhatu-symptoms {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            padding: 25px;
            border-radius: 16px;
            margin: 25px 0;
            border-left: 6px solid #ffc107;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }

        .selected-dhatu-symptoms h5 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .dhatu-symptom-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .dhatu-summary-card {
            background: white;
            padding: 18px;
            border-radius: 12px;
            border: 1px solid #ffeaa7;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .dhatu-summary-card h6 {
            color: #856404;
            margin-bottom: 12px;
            font-size: 16px;
            font-weight: 700;
        }

        .summary-symptom {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 8px;
            font-size: 13px;
            border-left: 4px solid #667eea;
        }

        .results-section {
            background: linear-gradient(135deg, #f1f2f6, #ddd6fe);
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .results-section h4 {
            color: #2d3436;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .severity-indicator {
            display: inline-block;
            padding: 10px 18px;
            border-radius: 25px;
            font-weight: 700;
            margin: 6px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .normal { 
            background: linear-gradient(135deg, #00b894, #00a085); 
            color: white; 
        }
        .mild { 
            background: linear-gradient(135deg, #fdcb6e, #f39c12); 
            color: #2d3436; 
        }
        .moderate { 
            background: linear-gradient(135deg, #e17055, #d63031); 
            color: white; 
        }
        .severe { 
            background: linear-gradient(135deg, #d63031, #a71e34); 
            color: white; 
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
            gap: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-decoration: none;
            display: inline-block;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #636e72, #2d3436);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 110, 114, 0.3);
        }

        .btn:disabled {
            background: #ddd;
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .floating-save {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 184, 148, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-save:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 184, 148, 0.5);
        }

        @media (max-width: 1200px) {
            .dhatu-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 16px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .dhatu-symptoms {
                grid-template-columns: 1fr;
            }
            
            .nav-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .patient-info {
                grid-template-columns: 1fr;
            }
            
            .dhatu-symptom-summary {
                grid-template-columns: 1fr;
            }
            
            .floating-save {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧬 DHATU DUSTI ASSESSMENT</h1>
            <p><strong>PILLAR 3 of 4-PCAM</strong></p>
            <p>Seven Tissue Assessment for Kṣaya and Vriddhi</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>

            <div class="patient-info" id="patient-info">
                <!-- Patient info will be loaded here -->
            </div>

            <div class="assessment-header">
                <h3>🧬 PILLAR 3: DHATU DUSTI ASSESSMENT</h3>
                <p>Each dhātu assessed for classical signs of kṣaya (depletion) and vriddhi (excess)</p>
            </div>

            <div class="instructions">
                <strong>📋 SCORING INSTRUCTIONS:</strong> Score 0-2 per symptom (0=Normal, 1=Mild Duṣṭi, 2=Moderate/Severe Duṣṭi). Click on symptoms present, then select severity. Assess for both Kṣaya (depletion) and Vriddhi (excess) symptoms for each dhatu.
            </div>

            <div class="dhatu-grid">
                <div class="dhatu-card">
                    <div class="dhatu-header">
                        <h4>🩸 RASA DHATU (Plasma/Lymph)</h4>
                    </div>
                    <div class="dhatu-content">
                        <div class="dhatu-symptoms">
                            <div class="symptom-category">
                                <h5>Kṣaya (Depletion)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="rasa" data-type="kshaya" data-symptom="Pale, dry, rough">
                                        Pale, dry, rough
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rasa" data-type="kshaya" data-symptom="Excessive thirst">
                                        Excessive thirst
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rasa" data-type="kshaya" data-symptom="Very less sweating">
                                        Very less sweating
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rasa" data-type="kshaya" data-symptom="Low enthusiasm, anxiety">
                                        Low enthusiasm, anxiety
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="symptom-category">
                                <h5>Vriddhi (Excess)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="rasa" data-type="vriddhi" data-symptom="Oily, dull">
                                        Oily, dull
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rasa" data-type="vriddhi" data-symptom="No thirst, heaviness">
                                        No thirst, heaviness
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rasa" data-type="vriddhi" data-symptom="Excessive, sticky sweating">
                                        Excessive, sticky sweating
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rasa" data-type="vriddhi" data-symptom="Dullness, lack of clarity">
                                        Dullness, lack of clarity
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="dhatu-scores">
                            <div class="score-display">
                                <span class="score-value" id="rasa-kshaya-score">0</span>
                                Kṣaya Score
                            </div>
                            <div class="score-display">
                                <span class="score-value" id="rasa-vriddhi-score">0</span>
                                Vriddhi Score
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dhatu-card">
                    <div class="dhatu-header">
                        <h4>❤️ RAKTA DHATU (Blood)</h4>
                    </div>
                    <div class="dhatu-content">
                        <div class="dhatu-symptoms">
                            <div class="symptom-category">
                                <h5>Kṣaya (Depletion)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="rakta" data-type="kshaya" data-symptom="Pale skin color">
                                        Pale skin color
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rakta" data-type="kshaya" data-symptom="Loss of luster, pale sclera">
                                        Loss of luster, pale sclera
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rakta" data-type="kshaya" data-symptom="Easy bruising, fatigue">
                                        Easy bruising, fatigue
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rakta" data-type="kshaya" data-symptom="Low drive, passive">
                                        Low drive, passive
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="symptom-category">
                                <h5>Vriddhi (Excess)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="rakta" data-type="vriddhi" data-symptom="Red, flushed skin color">
                                        Red, flushed skin color
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rakta" data-type="vriddhi" data-symptom="Redness, burning eye appearance">
                                        Redness, burning eye appearance
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rakta" data-type="vriddhi" data-symptom="Nasal/gum bleeding">
                                        Nasal/gum bleeding
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="rakta" data-type="vriddhi" data-symptom="Irritable, short-tempered">
                                        Irritable, short-tempered
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="dhatu-scores">
                            <div class="score-display">
                                <span class="score-value" id="rakta-kshaya-score">0</span>
                                Kṣaya Score
                            </div>
                            <div class="score-display">
                                <span class="score-value" id="rakta-vriddhi-score">0</span>
                                Vriddhi Score
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dhatu-card">
                    <div class="dhatu-header">
                        <h4>💪 MAMSA DHATU (Muscle)</h4>
                    </div>
                    <div class="dhatu-content">
                        <div class="dhatu-symptoms">
                            <div class="symptom-category">
                                <h5>Kṣaya (Depletion)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="mamsa" data-type="kshaya" data-symptom="Muscle wasting, weakness">
                                        Muscle wasting, weakness
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="mamsa" data-type="kshaya" data-symptom="Emaciation">
                                        Emaciation
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="mamsa" data-type="kshaya" data-symptom="Unstable posture">
                                        Unstable posture
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="symptom-category">
                                <h5>Vriddhi (Excess)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="mamsa" data-type="vriddhi" data-symptom="Heaviness, stiffness">
                                        Heaviness, stiffness
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="mamsa" data-type="vriddhi" data-symptom="Abscesses, fibroids, cysts">
                                        Abscesses, fibroids, cysts
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="mamsa" data-type="vriddhi" data-symptom="Rigid, limited flexibility">
                                        Rigid, limited flexibility
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="dhatu-scores">
                            <div class="score-display">
                                <span class="score-value" id="mamsa-kshaya-score">0</span>
                                Kṣaya Score
                            </div>
                            <div class="score-display">
                                <span class="score-value" id="mamsa-vriddhi-score">0</span>
                                Vriddhi Score
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dhatu-card">
                    <div class="dhatu-header">
                        <h4>🫅 MEDA DHATU (Adipose)</h4>
                    </div>
                    <div class="dhatu-content">
                        <div class="dhatu-symptoms">
                            <div class="symptom-category">
                                <h5>Kṣaya (Depletion)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="meda" data-type="kshaya" data-symptom="Thin, underweight">
                                        Thin, underweight
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="meda" data-type="kshaya" data-symptom="Dryness">
                                        Dryness
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="meda" data-type="kshaya" data-symptom="Tiredness, weakness">
                                        Tiredness, weakness
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="symptom-category">
                                <h5>Vriddhi (Excess)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="meda" data-type="vriddhi" data-symptom="Obesity, overweight">
                                        Obesity, overweight
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="meda" data-type="vriddhi" data-symptom="Excess sweat, oil secretion">
                                        Excess sweat, oil secretion
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="meda" data-type="vriddhi" data-symptom="Lethargy, heaviness">
                                        Lethargy, heaviness
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="dhatu-scores">
                            <div class="score-display">
                                <span class="score-value" id="meda-kshaya-score">0</span>
                                Kṣaya Score
                            </div>
                            <div class="score-display">
                                <span class="score-value" id="meda-vriddhi-score">0</span>
                                Vriddhi Score
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dhatu-card">
                    <div class="dhatu-header">
                        <h4>🦴 ASTHI DHATU (Bone)</h4>
                    </div>
                    <div class="dhatu-content">
                        <div class="dhatu-symptoms">
                            <div class="symptom-category">
                                <h5>Kṣaya (Depletion)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="asthi" data-type="kshaya" data-symptom="Brittle bones, Cracking joints">
                                        Brittle bones, Cracking joints
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="asthi" data-type="kshaya" data-symptom="Brittle, weak, falling nails/hair">
                                        Brittle, weak, falling nails/hair
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="asthi" data-type="kshaya" data-symptom="Weak spine, stooping">
                                        Weak spine, stooping
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="symptom-category">
                                <h5>Vriddhi (Excess)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="asthi" data-type="vriddhi" data-symptom="Thick, stiff bones/joints">
                                        Thick, stiff bones/joints
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="asthi" data-type="vriddhi" data-symptom="Thick, hard, rigid nails/hair">
                                        Thick, hard, rigid nails/hair
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="asthi" data-type="vriddhi" data-symptom="Rigid posture, deformities">
                                        Rigid posture, deformities
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="dhatu-scores">
                            <div class="score-display">
                                <span class="score-value" id="asthi-kshaya-score">0</span>
                                Kṣaya Score
                            </div>
                            <div class="score-display">
                                <span class="score-value" id="asthi-vriddhi-score">0</span>
                                Vriddhi Score
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dhatu-card">
                    <div class="dhatu-header">
                        <h4>🧠 MAJJA DHATU (Marrow/Nervous System)</h4>
                    </div>
                    <div class="dhatu-content">
                        <div class="dhatu-symptoms">
                            <div class="symptom-category">
                                <h5>Kṣaya (Depletion)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="majja" data-type="kshaya" data-symptom="Hollow, weak bone pain">
                                        Hollow, weak bone pain
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="majja" data-type="kshaya" data-symptom="Numbness, tremors, tingling">
                                        Numbness, tremors, tingling
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="majja" data-type="kshaya" data-symptom="Weak vision, poor memory">
                                        Weak vision, poor memory
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="symptom-category">
                                <h5>Vriddhi (Excess)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="majja" data-type="vriddhi" data-symptom="Deep heaviness in bones">
                                        Deep heaviness in bones
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="majja" data-type="vriddhi" data-symptom="Heaviness, sluggish response">
                                        Heaviness, sluggish response
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="majja" data-type="vriddhi" data-symptom="Lethargy, slow cognition">
                                        Lethargy, slow cognition
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="dhatu-scores">
                            <div class="score-display">
                                <span class="score-value" id="majja-kshaya-score">0</span>
                                Kṣaya Score
                            </div>
                            <div class="score-display">
                                <span class="score-value" id="majja-vriddhi-score">0</span>
                                Vriddhi Score
                            </div>
                        </div>
                    </div>
                </div>

                <div class="dhatu-card">
                    <div class="dhatu-header">
                        <h4>🌱♀️ ŚUKRA/ĀRTAVA DHATU (Reproductive)</h4>
                    </div>
                    <div class="dhatu-content">
                        <div class="dhatu-symptoms">
                            <div class="symptom-category">
                                <h5>Kṣaya (Depletion)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="shukra" data-type="kshaya" data-symptom="Low desire, low quantity, ED">
                                        Low desire, low quantity, ED
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="shukra" data-type="kshaya" data-symptom="Scanty, irregular menstrual cycle">
                                        Scanty, irregular menstrual cycle
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="shukra" data-type="kshaya" data-symptom="Infertility, weak sperm/ova">
                                        Infertility, weak sperm/ova
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="symptom-category">
                                <h5>Vriddhi (Excess)</h5>
                                <ul class="symptom-list">
                                    <li class="symptom-item" data-dhatu="shukra" data-type="vriddhi" data-symptom="Hyperlibido, PCOD, wet dreams">
                                        Hyperlibido, PCOD, wet dreams
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="shukra" data-type="vriddhi" data-symptom="Heavy bleeding, frequent cycle">
                                        Heavy bleeding, frequent cycle
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                    <li class="symptom-item" data-dhatu="shukra" data-type="vriddhi" data-symptom="Premature ejaculation, ovarian cysts">
                                        Premature ejaculation, ovarian cysts
                                        <div class="severity-controls">
                                            <button class="severity-btn" data-score="1">1</button>
                                            <button class="severity-btn" data-score="2">2</button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="dhatu-scores">
                            <div class="score-display">
                                <span class="score-value" id="shukra-kshaya-score">0</span>
                                Kṣaya Score
                            </div>
                            <div class="score-display">
                                <span class="score-value" id="shukra-vriddhi-score">0</span>
                                Vriddhi Score
                            </div>
                        </div>
                    </div>
                </div>

            </div>



            <div class="results-section">
                <h4>📊 Dhatu Dusti Assessment Results</h4>
                <div id="dhatu-results">Complete the assessment to see results...</div>
            </div>
            
            <div class="nav-buttons">
                <a href="dosha-dusti.html" class="btn btn-secondary">← Back to Dosha Assessment</a>
                <button class="btn btn-primary" id="dhatu-complete-btn" onclick="completeDhatuAssessment()" disabled>Complete Assessment → Srotas</button>
            </div>
        </div>
    </div>

    <button class="floating-save" onclick="saveDhatuData()" title="Save Progress">💾</button>

    <script>
        // Enhanced Dhatu Assessment System
        let dhatuData = {
            scores: {
                rasa: { kshaya: 0, vriddhi: 0 },
                rakta: { kshaya: 0, vriddhi: 0 },
                mamsa: { kshaya: 0, vriddhi: 0 },
                meda: { kshaya: 0, vriddhi: 0 },
                asthi: { kshaya: 0, vriddhi: 0 },
                majja: { kshaya: 0, vriddhi: 0 },
                shukra: { kshaya: 0, vriddhi: 0 }
            },
            selectedSymptoms: {
                rasa: { kshaya: [], vriddhi: [] },
                rakta: { kshaya: [], vriddhi: [] },
                mamsa: { kshaya: [], vriddhi: [] },
                meda: { kshaya: [], vriddhi: [] },
                asthi: { kshaya: [], vriddhi: [] },
                majja: { kshaya: [], vriddhi: [] },
                shukra: { kshaya: [], vriddhi: [] }
            },
            completed: false,
            timestamp: null
        };

        let patientData = {};
        let agniData = {};
        let doshaData = {};
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Initializing Enhanced Dhatu Assessment...');
            showLoadingState();
            
            setTimeout(() => {
                loadPreviousData();
                setupEventListeners();
                loadPreviousDhatuData();
                updateDisplay();
                hideLoadingState();
                
                // Smooth entrance animation
                document.querySelector('.container').style.opacity = '0';
                document.querySelector('.container').style.transform = 'translateY(20px)';
                setTimeout(() => {
                    document.querySelector('.container').style.transition = 'all 0.6s ease';
                    document.querySelector('.container').style.opacity = '1';
                    document.querySelector('.container').style.transform = 'translateY(0)';
                }, 100);
            }, 500);
        });

        function showLoadingState() {
            const resultsEl = document.getElementById('dhatu-results');
            resultsEl.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div><br>Loading assessment...</div>';
        }

        function hideLoadingState() {
            // Loading complete - results will be updated by updateDisplay()
        }

        function loadPreviousData() {
            try {
                // Load combined data
                const combined = localStorage.getItem('4pcam_combined_data');
                if (combined) {
                    const data = JSON.parse(combined);
                    patientData = data.patient || {};
                    agniData = data.agni || {};
                    doshaData = data.dosha || {};
                    console.log('✅ Combined data loaded successfully');
                    displayPatientInfo();
                }

                // Validate prerequisites
                if (!patientData.name || !agniData.completed || !doshaData.completed) {
                    showError('Please complete all previous assessments first');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return false;
                }
                return true;
            } catch (error) {
                console.error('❌ Error loading previous data:', error);
                showError('Error loading previous assessments');
                return false;
            }
        }

        function displayPatientInfo() {
            const infoEl = document.getElementById('patient-info');
            if (!patientData.name) return;

            const agniStatus = getAgniStatus();
            const doshaStatus = getDoshaStatus();
            
            infoEl.innerHTML = `
                <div class="patient-info-item">
                    <strong>Patient Name</strong>
                    ${patientData.name}
                </div>
                <div class="patient-info-item">
                    <strong>Age/Sex</strong>
                    ${patientData.ageSex}
                </div>
                <div class="patient-info-item">
                    <strong>Assessment Date</strong>
                    ${patientData.assessmentDate}
                </div>
                <div class="patient-info-item">
                    <strong>Chief Complaints</strong>
                    ${patientData.complaints.substring(0, 60)}${patientData.complaints.length > 60 ? '...' : ''}
                </div>
                <div class="patient-info-item">
                    <strong>Agni Status</strong>
                    <span class="severity-indicator ${getAgniSeverityClass()}">${agniStatus}</span>
                </div>
                <div class="patient-info-item">
                    <strong>Dosha Status</strong>
                    <span class="severity-indicator ${getDoshaSeverityClass()}">${doshaStatus}</span>
                </div>
            `;

            // Animate patient info cards
            setTimeout(() => {
                document.querySelectorAll('.patient-info-item').forEach((item, index) => {
                    item.style.opacity = '0';
                    item.style.transform = 'translateY(10px)';
                    setTimeout(() => {
                        item.style.transition = 'all 0.4s ease';
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            }, 200);
        }

        function getAgniStatus() {
            if (!agniData.completed) return 'Not completed';
            const totalDusti = (agniData.vishama || 0) + (agniData.tikshna || 0) + (agniData.manda || 0);
            if (totalDusti === 0) return 'Sama Agni';
            if (totalDusti <= 4) return 'Mild Agni Dusti';
            if (totalDusti <= 6) return 'Moderate Agni Dusti';
            return 'Severe Agni Dusti';
        }

        function getDoshaStatus() {
            if (!doshaData.completed) return 'Not completed';
            const vScore = doshaData.vata || 0;
            const pScore = doshaData.pitta || 0;
            const kScore = doshaData.kapha || 0;
            const maxScore = Math.max(vScore, pScore, kScore);
            
            if (maxScore === 0) return 'Balanced Constitution';
            if (maxScore === vScore) return `Vata Dominant (${vScore})`;
            if (maxScore === pScore) return `Pitta Dominant (${pScore})`;
            if (maxScore === kScore) return `Kapha Dominant (${kScore})`;
            return 'Balanced Constitution';
        }

        function getAgniSeverityClass() {
            const totalDusti = (agniData.vishama || 0) + (agniData.tikshna || 0) + (agniData.manda || 0);
            if (totalDusti === 0) return 'normal';
            if (totalDusti <= 4) return 'mild';
            if (totalDusti <= 6) return 'moderate';
            return 'severe';
        }

        function getDoshaSeverityClass() {
            const maxScore = Math.max(doshaData.vata || 0, doshaData.pitta || 0, doshaData.kapha || 0);
            if (maxScore === 0) return 'normal';
            if (maxScore <= 3) return 'mild';
            if (maxScore <= 6) return 'moderate';
            return 'severe';
        }

        function setupEventListeners() {
            // Symptom selection listeners
            document.querySelectorAll('.symptom-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('severity-btn')) return;
                    handleSymptomClick(item);
                });
            });

            // Severity button listeners
            document.querySelectorAll('.severity-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleSeverityClick(btn);
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Auto-save on visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveDhatuData();
                }
            });

            console.log('✅ Event listeners setup complete');
        }

        function handleSymptomClick(item) {
            const dhatu = item.dataset.dhatu;
            const type = item.dataset.type;
            const symptom = item.dataset.symptom;

            // Add click animation
            item.style.transform = 'scale(0.95)';
            setTimeout(() => {
                item.style.transform = '';
            }, 150);

            if (item.classList.contains('selected')) {
                // Deselect
                item.classList.remove('selected');
                item.querySelectorAll('.severity-btn').forEach(btn => btn.classList.remove('active'));
                removeSymptom(dhatu, type, symptom);
                showToast(`Removed: ${symptom}`, 'info');
            } else {
                // Select with default severity 1
                item.classList.add('selected');
                const defaultBtn = item.querySelector('.severity-btn[data-score="1"]');
                if (defaultBtn) {
                    defaultBtn.classList.add('active');
                }
                addSymptom(dhatu, type, symptom, 1);
                showToast(`Added: ${symptom} (Mild)`, 'success');
            }
            
            updateDisplay();
            saveDhatuData();
        }

        function handleSeverityClick(btn) {
            const item = btn.closest('.symptom-item');
            const dhatu = item.dataset.dhatu;
            const type = item.dataset.type;
            const symptom = item.dataset.symptom;
            const severity = parseInt(btn.dataset.score);

            // Add button animation
            btn.style.transform = 'scale(1.2)';
            setTimeout(() => {
                btn.style.transform = '';
            }, 200);

            // Update button states
            item.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update symptom severity
            updateSymptomSeverity(dhatu, type, symptom, severity);
            
            const severityText = severity === 1 ? 'Mild' : 'Moderate/Severe';
            showToast(`Updated: ${symptom} (${severityText})`, 'success');
            
            updateDisplay();
            saveDhatuData();
        }

        function addSymptom(dhatu, type, symptom, severity) {
            // Remove existing symptom if present
            removeSymptom(dhatu, type, symptom);
            
            // Add new symptom
            dhatuData.selectedSymptoms[dhatu][type].push({
                symptom: symptom,
                severity: severity,
                severityText: severity === 1 ? 'Mild' : 'Moderate/Severe'
            });

            // Update scores
            dhatuData.scores[dhatu][type] += severity;
        }

        function removeSymptom(dhatu, type, symptom) {
            const symptoms = dhatuData.selectedSymptoms[dhatu][type];
            const index = symptoms.findIndex(s => s.symptom === symptom);
            
            if (index !== -1) {
                // Subtract from score
                dhatuData.scores[dhatu][type] -= symptoms[index].severity;
                // Ensure score doesn't go negative
                if (dhatuData.scores[dhatu][type] < 0) {
                    dhatuData.scores[dhatu][type] = 0;
                }
                // Remove from array
                symptoms.splice(index, 1);
            }
        }

        function updateSymptomSeverity(dhatu, type, symptom, newSeverity) {
            const symptoms = dhatuData.selectedSymptoms[dhatu][type];
            const symptomObj = symptoms.find(s => s.symptom === symptom);
            
            if (symptomObj) {
                // Update score
                dhatuData.scores[dhatu][type] = dhatuData.scores[dhatu][type] - symptomObj.severity + newSeverity;
                // Update symptom
                symptomObj.severity = newSeverity;
                symptomObj.severityText = newSeverity === 1 ? 'Mild' : 'Moderate/Severe';
            }
        }

        function loadPreviousDhatuData() {
            try {
                const saved = localStorage.getItem('4pcam_dhatu_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    dhatuData = { ...dhatuData, ...data };
                    restoreSelections();
                    console.log('✅ Previous dhatu data loaded successfully');
                    showToast('Previous assessment data loaded', 'info');
                }
            } catch (error) {
                console.error('❌ Error loading previous dhatu data:', error);
                showError('Error loading previous dhatu data');
            }
        }

        function restoreSelections() {
            Object.keys(dhatuData.selectedSymptoms).forEach(dhatu => {
                ['kshaya', 'vriddhi'].forEach(type => {
                    dhatuData.selectedSymptoms[dhatu][type].forEach(symptomObj => {
                        const item = document.querySelector(`[data-dhatu="${dhatu}"][data-type="${type}"][data-symptom="${symptomObj.symptom}"]`);
                        if (item) {
                            item.classList.add('selected');
                            const btn = item.querySelector(`[data-score="${symptomObj.severity}"]`);
                            if (btn) {
                                item.querySelectorAll('.severity-btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                            }
                        }
                    });
                });
            });
        }

        function updateDisplay() {
            // Update score displays with animation
            Object.keys(dhatuData.scores).forEach(dhatu => {
                ['kshaya', 'vriddhi'].forEach(type => {
                    const scoreEl = document.getElementById(`${dhatu}-${type}-score`);
                    if (scoreEl) {
                        const newScore = dhatuData.scores[dhatu][type];
                        const currentScore = parseInt(scoreEl.textContent) || 0;
                        
                        if (newScore !== currentScore) {
                            animateScoreChange(scoreEl, currentScore, newScore);
                        }
                    }
                });
            });

            // Update results
            updateResults();

            // Update completion button
            updateCompletionButton();

            // Update progress bar
            updateProgressBar();
        }

        function animateScoreChange(element, fromScore, toScore) {
            element.style.transform = 'scale(1.2)';
            element.style.color = '#ff6b6b';
            
            setTimeout(() => {
                element.textContent = toScore;
                element.style.transform = 'scale(1)';
                element.style.color = '';
            }, 200);
        }



        function updateResults() {
            let resultsHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px;">';
            
            let totalKshaya = 0;
            let totalVriddhi = 0;
            let affectedDhatus = 0;
            let kshayaDhatus = [];
            let vriddhiDhatus = [];

            Object.keys(dhatuData.scores).forEach(dhatu => {
                const kshayaScore = dhatuData.scores[dhatu].kshaya;
                const vriddhiScore = dhatuData.scores[dhatu].vriddhi;
                const totalScore = kshayaScore + vriddhiScore;
                
                totalKshaya += kshayaScore;
                totalVriddhi += vriddhiScore;
                
                if (totalScore > 0) affectedDhatus++;

                // Determine dominant pattern for this dhatu
                let dominantPattern = '';
                let patternColor = '#6c757d';
                if (kshayaScore > vriddhiScore && kshayaScore > 0) {
                    dominantPattern = 'Kṣaya';
                    patternColor = '#e17055';
                    kshayaDhatus.push({
                        name: dhatu.charAt(0).toUpperCase() + dhatu.slice(1),
                        score: kshayaScore
                    });
                } else if (vriddhiScore > kshayaScore && vriddhiScore > 0) {
                    dominantPattern = 'Vriddhi';
                    patternColor = '#74b9ff';
                    vriddhiDhatus.push({
                        name: dhatu.charAt(0).toUpperCase() + dhatu.slice(1),
                        score: vriddhiScore
                    });
                } else if (kshayaScore === vriddhiScore && kshayaScore > 0) {
                    dominantPattern = 'Mixed';
                    patternColor = '#f39c12';
                }

                let severity = 'normal';
                let severityText = 'Normal';
                
                if (totalScore >= 1 && totalScore <= 2) {
                    severity = 'mild';
                    severityText = 'Mild Duṣṭi';
                } else if (totalScore >= 3 && totalScore <= 4) {
                    severity = 'moderate';
                    severityText = 'Moderate Duṣṭi';
                } else if (totalScore >= 5) {
                    severity = 'severe';
                    severityText = 'Severe Duṣṭi';
                }

                resultsHTML += `
                    <div style="background: white; padding: 15px; border-radius: 12px; border: 2px solid ${getSeverityColor(severity)}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <strong style="color: #2d3436; font-size: 16px;">${dhatu.charAt(0).toUpperCase() + dhatu.slice(1)} Dhatu</strong>
                        <div style="margin: 8px 0;">
                            <span style="font-size: 24px; font-weight: 800; color: ${getSeverityColor(severity)};">${totalScore}</span>
                        </div>
                        <div class="severity-indicator ${severity}" style="font-size: 12px; padding: 6px 12px;">${severityText}</div>
                        ${dominantPattern ? `
                            <div style="margin-top: 8px; padding: 4px 8px; background: ${patternColor}; color: white; border-radius: 6px; font-size: 12px; font-weight: 600; text-align: center;">
                                ${dominantPattern}
                            </div>
                        ` : ''}
                        <div style="margin-top: 8px; font-size: 13px; color: #636e72;">
                            Kṣaya: ${kshayaScore} | Vriddhi: ${vriddhiScore}
                        </div>
                    </div>
                `;
            });
            
            resultsHTML += '</div>';

            const totalScore = totalKshaya + totalVriddhi;
            let overallSeverity = 'normal';
            let overallText = 'No significant dhatu dusti';
            
            if (totalScore >= 1 && totalScore <= 7) {
                overallSeverity = 'mild';
                overallText = 'Mild overall dhatu imbalance';
            } else if (totalScore >= 8 && totalScore <= 14) {
                overallSeverity = 'moderate';
                overallText = 'Moderate dhatu dysfunction';
            } else if (totalScore >= 15) {
                overallSeverity = 'severe';
                overallText = 'Severe dhatu pathology';
            }

            const totalSymptoms = Object.values(dhatuData.selectedSymptoms).reduce((total, dhatu) => 
                total + dhatu.kshaya.length + dhatu.vriddhi.length, 0);

            // Build pattern summary
            let patternSummary = '';
            if (kshayaDhatus.length > 0 || vriddhiDhatus.length > 0) {
                patternSummary = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0;">';
                
                if (kshayaDhatus.length > 0) {
                    const sortedKshaya = kshayaDhatus.sort((a, b) => b.score - a.score);
                    patternSummary += `
                        <div style="background: linear-gradient(135deg, #ffe5d9, #f3d1cc); padding: 15px; border-radius: 12px; border-left: 4px solid #e17055;">
                            <h6 style="color: #a74a2c; margin-bottom: 10px; font-weight: 700;">🔽 KṢAYA (Depletion) DHATUS</h6>
                            ${sortedKshaya.map(dhatu => `
                                <div style="background: rgba(255,255,255,0.7); margin: 4px 0; padding: 6px 10px; border-radius: 6px; font-size: 13px;">
                                    ${dhatu.name} (Score: ${dhatu.score})
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (vriddhiDhatus.length > 0) {
                    const sortedVriddhi = vriddhiDhatus.sort((a, b) => b.score - a.score);
                    patternSummary += `
                        <div style="background: linear-gradient(135deg, #e3f2fd, #d1ecf1); padding: 15px; border-radius: 12px; border-left: 4px solid #74b9ff;">
                            <h6 style="color: #2980b9; margin-bottom: 10px; font-weight: 700;">🔼 VRIDDHI (Excess) DHATUS</h6>
                            ${sortedVriddhi.map(dhatu => `
                                <div style="background: rgba(255,255,255,0.7); margin: 4px 0; padding: 6px 10px; border-radius: 6px; font-size: 13px;">
                                    ${dhatu.name} (Score: ${dhatu.score})
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                patternSummary += '</div>';
            }

            resultsHTML += `
                <div style="background: linear-gradient(135deg, #e8f4fd, #d1ecf1); padding: 25px; border-radius: 16px; border-left: 6px solid #74b9ff;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div><strong>Total Dhatu Score:</strong> ${totalScore}</div>
                        <div><strong>Kṣaya Score:</strong> ${totalKshaya}</div>
                        <div><strong>Vriddhi Score:</strong> ${totalVriddhi}</div>
                        <div><strong>Affected Dhatus:</strong> ${affectedDhatus}/7</div>
                        <div><strong>Selected Symptoms:</strong> ${totalSymptoms}</div>
                    </div>
                    
                    ${patternSummary}
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <strong style="font-size: 1.1em;">Overall Assessment:</strong><br>
                        <span class="severity-indicator ${overallSeverity}" style="font-size: 16px; margin-top: 10px; display: inline-block;">${overallText}</span>
                    </div>
                </div>
            `;

            document.getElementById('dhatu-results').innerHTML = resultsHTML;
        }

        function getSeverityColor(severity) {
            const colors = {
                normal: '#00b894',
                mild: '#f39c12',
                moderate: '#e17055',
                severe: '#d63031'
            };
            return colors[severity] || '#6c757d';
        }

        function updateCompletionButton() {
            const completeBtn = document.getElementById('dhatu-complete-btn');
            const totalSymptoms = Object.values(dhatuData.selectedSymptoms).reduce((total, dhatu) => 
                total + dhatu.kshaya.length + dhatu.vriddhi.length, 0);

            completeBtn.disabled = false;
            completeBtn.style.background = 'linear-gradient(135deg, #00b894, #00a085)';
            completeBtn.style.opacity = '1';
            completeBtn.style.cursor = 'pointer';
        }

        function updateProgressBar() {
            const totalSymptoms = Object.values(dhatuData.selectedSymptoms).reduce((total, dhatu) => 
                total + dhatu.kshaya.length + dhatu.vriddhi.length, 0);
            
            const progress = Math.min(75 + (totalSymptoms > 0 ? 25 : 0), 100);
            const progressFill = document.querySelector('.progress-fill');
            progressFill.style.width = `${progress}%`;
        }

        function saveDhatuData() {
            try {
                dhatuData.timestamp = new Date().toISOString();
                localStorage.setItem('4pcam_dhatu_data', JSON.stringify(dhatuData));
                showToast('Assessment data saved successfully', 'success');
                console.log('✅ Dhatu data saved successfully');
            } catch (error) {
                console.error('❌ Error saving dhatu data:', error);
                showError('Failed to save assessment data');
            }
        }

        function completeDhatuAssessment() {
            try {
                // Mark as completed
                dhatuData.completed = true;
                dhatuData.completedAt = new Date().toISOString();
                saveDhatuData();

                // Save combined data for final report
                saveCombinedData();

                const totalScore = Object.values(dhatuData.scores).reduce((total, dhatu) => 
                    total + dhatu.kshaya + dhatu.vriddhi, 0);
                const affectedDhatus = Object.values(dhatuData.scores).filter(dhatu => 
                    dhatu.kshaya > 0 || dhatu.vriddhi > 0).length;

                // Show completion message
                showSuccess(`Dhatu assessment completed successfully!\n\nTotal Score: ${totalScore}\nAffected Dhatus: ${affectedDhatus}/7\n\nProceeding to Srotas assessment...`);
                
                setTimeout(() => {
                    window.location.href = 'sroto-dusti.html';
                }, 2000);

            } catch (error) {
                console.error('❌ Error completing dhatu assessment:', error);
                showError('Error completing assessment. Please try again.');
            }
        }

        function saveCombinedData() {
            try {
                let combinedData = {};
                
                // Load existing combined data
                const existing = localStorage.getItem('4pcam_combined_data');
                if (existing) {
                    combinedData = JSON.parse(existing);
                }

                // Update with current data
                combinedData.patient = patientData;
                combinedData.agni = agniData;
                combinedData.dosha = doshaData;
                combinedData.dhatu = dhatuData;
                combinedData.timestamp = new Date().toISOString();

                localStorage.setItem('4pcam_combined_data', JSON.stringify(combinedData));
                console.log('✅ Combined data saved successfully with dhatu assessment');
            } catch (error) {
                console.error('❌ Error saving combined data:', error);
                throw error;
            }
        }

        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key.toLowerCase()) {
                    case 's':
                        e.preventDefault();
                        saveDhatuData();
                        break;
                    case 'enter':
                        e.preventDefault();
                        if (!document.getElementById('dhatu-complete-btn').disabled) {
                            completeDhatuAssessment();
                        }
                        break;
                }
            }
            if (e.key === 'Escape') {
                if (confirm('Are you sure you want to go back? Progress will be saved.')) {
                    saveDhatuData();
                    window.location.href = 'dosha-dusti.html';
                }
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${getToastColor(type)};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 500;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function getToastColor(type) {
            const colors = {
                success: '#00b894',
                error: '#d63031',
                warning: '#f39c12',
                info: '#74b9ff'
            };
            return colors[type] || colors.info;
        }

        function showError(message) {
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        // Auto-save functionality
        let autoSaveTimer;
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                saveDhatuData();
            }, 2000);
        }

        // Schedule auto-save on data changes
        const originalAddSymptom = addSymptom;
        addSymptom = function(...args) {
            originalAddSymptom.apply(this, args);
            scheduleAutoSave();
        };

        const originalRemoveSymptom = removeSymptom;
        removeSymptom = function(...args) {
            originalRemoveSymptom.apply(this, args);
            scheduleAutoSave();
        };

        const originalUpdateSymptomSeverity = updateSymptomSeverity;
        updateSymptomSeverity = function(...args) {
            originalUpdateSymptomSeverity.apply(this, args);
            scheduleAutoSave();
        };

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            saveDhatuData();
        });

        console.log("✅ Enhanced Dhatu Dusti Assessment System loaded successfully!");
    </script>
</body>
</html>
